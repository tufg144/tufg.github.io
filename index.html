<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Умное расписание уроков</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #8a2be2;
      --primary-dark: #6a0dad;
      --secondary: #00b4d8;
      --dark-bg: #111;
      --dark-card: #1e1e1e;
      --dark-text: #eee;
      --light-bg: #f4f4f4;
      --light-card: #fff;
      --light-text: #222;
      --success: #00cc66;
      --warning: #ff9900;
      --error: #ff3333;
      --weekend: #ff6b6b;
      --transition: all 0.3s ease;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--dark-bg);
      color: var(--dark-text);
      line-height: 1.6;
      transition: var(--transition);
      overflow-x: hidden;
      background-image: 
        radial-gradient(circle at 15% 50%, rgba(138, 43, 226, 0.1), transparent 25%),
        radial-gradient(circle at 85% 30%, rgba(0, 180, 216, 0.1), transparent 25%);
      min-height: 100vh;
      padding-bottom: 20px;
    }

    body.light {
      background: var(--light-bg);
      color: var(--light-text);
      background-image: 
        radial-gradient(circle at 15% 50%, rgba(138, 43, 226, 0.05), transparent 25%),
        radial-gradient(circle at 85% 30%, rgba(0, 180, 216, 0.05), transparent 25%);
    }

    /* Layout */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    header {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      padding: 20px 0;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      position: relative;
      transition: var(--transition);
    }

    body.light header {
      background: linear-gradient(135deg, var(--primary), #7c3aed);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }

    .logo-area {
      display: flex;
      flex-direction: column;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.8rem;
      font-weight: 700;
      color: white;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .logo i {
      font-size: 2rem;
      animation: pulse 2s infinite;
    }

    .made-by {
      font-size: 0.9rem;
      opacity: 0.8;
      margin-top: 2px;
      color: white;
    }

    .social-links {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .social-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      transition: var(--transition);
      position: relative;
    }

    .social-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }

    .social-tooltip {
      position: absolute;
      bottom: -35px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 0.8rem;
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: var(--transition);
    }

    .social-btn:hover .social-tooltip {
      opacity: 1;
      visibility: visible;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    /* Current lesson section */
    .current-lesson-card {
      background: var(--dark-card);
      border-radius: 16px;
      padding: 25px;
      margin: 25px 0;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    body.light .current-lesson-card {
      background: var(--light-card);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .current-lesson-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 5px;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
    }

    .lesson-status {
      display: inline-block;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 500;
      margin-bottom: 15px;
    }

    .status-now {
      background: var(--success);
      color: white;
      animation: blink 2s infinite;
    }

    @keyframes blink {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }

    .status-next {
      background: var(--warning);
      color: black;
    }

    .status-none {
      background: #666;
      color: white;
    }

    .lesson-title {
      font-size: 1.8rem;
      margin-bottom: 10px;
      color: var(--primary);
      transition: var(--transition);
    }

    body.light .lesson-title {
      color: var(--primary-dark);
    }

    .lesson-time {
      font-size: 1.2rem;
      margin-bottom: 15px;
      color: var(--secondary);
    }

    .timer {
      font-size: 1.1rem;
      margin: 15px 0;
      padding: 10px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      display: inline-block;
    }

    body.light .timer {
      background: rgba(0, 0, 0, 0.05);
    }

    .lesson-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    /* Buttons */
    button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background: var(--primary);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 10px;
      cursor: pointer;
      transition: var(--transition);
      font-weight: 600;
      box-shadow: 0 4px 10px rgba(138, 43, 226, 0.3);
    }

    button:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 6px 14px rgba(138, 43, 226, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    button.secondary {
      background: var(--secondary);
      box-shadow: 0 4px 10px rgba(0, 180, 216, 0.3);
    }

    button.secondary:hover {
      background: #0096b4;
      box-shadow: 0 6px 14px rgba(0, 180, 216, 0.4);
    }

    button.outline {
      background: transparent;
      border: 2px solid var(--primary);
      color: var(--primary);
      box-shadow: none;
    }

    button.outline:hover {
      background: var(--primary);
      color: white;
    }

    button.danger {
      background: var(--error);
      box-shadow: 0 4px 10px rgba(255, 51, 51, 0.3);
    }

    button.danger:hover {
      background: #e60000;
      box-shadow: 0 6px 14px rgba(255, 51, 51, 0.4);
    }

    /* Weekday buttons */
    .weekday-buttons {
      display: flex;
      gap: 8px;
      margin: 20px 0;
      flex-wrap: wrap;
      justify-content: center;
    }

    .weekday-btn {
      flex: 1;
      min-width: 40px;
      max-width: 60px;
      padding: 12px 5px;
      border-radius: 10px;
      background: var(--dark-card);
      color: var(--dark-text);
      border: 2px solid transparent;
      cursor: pointer;
      transition: var(--transition);
      font-weight: 600;
      text-align: center;
    }

    body.light .weekday-btn {
      background: var(--light-card);
      color: var(--light-text);
    }

    .weekday-btn.active {
      background: var(--primary);
      color: white;
      box-shadow: 0 4px 10px rgba(138, 43, 226, 0.3);
    }

    .weekday-btn.weekend {
      background: rgba(255, 107, 107, 0.2);
    }

    .weekday-btn.weekend.active {
      background: var(--weekend);
    }

    /* Schedule table */
    .schedule-container {
      background: var(--dark-card);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      margin-bottom: 30px;
      transition: var(--transition);
      overflow-x: auto;
    }

    body.light .schedule-container {
      background: var(--light-card);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .schedule-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 500px;
    }

    .schedule-table th {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      padding: 15px;
      text-align: left;
      font-weight: 600;
    }

    .schedule-table tr {
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      transition: var(--transition);
    }

    body.light .schedule-table tr {
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .schedule-table tr:last-child {
      border-bottom: none;
    }

    .schedule-table tr:hover {
      background: rgba(138, 43, 226, 0.1);
    }

    .schedule-table td {
      padding: 15px;
    }

    .time-cell {
      font-weight: 600;
      color: var(--secondary);
      white-space: nowrap;
    }

    .subject-cell {
      font-weight: 500;
    }

    .action-cell {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* Login panel */
    .login-panel {
      background: var(--dark-card);
      border-radius: 16px;
      padding: 25px;
      margin: 30px auto;
      max-width: 500px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      transition: var(--transition);
    }

    body.light .login-panel {
      background: var(--light-card);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .login-panel h3 {
      margin-bottom: 20px;
      color: var(--primary);
      text-align: center;
    }

    .input-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }

    input, select {
      width: 100%;
      padding: 12px 15px;
      border-radius: 10px;
      border: 2px solid rgba(255, 255, 255, 0.1);
      background: rgba(0, 0, 0, 0.2);
      color: var(--dark-text);
      font-size: 1rem;
      transition: var(--transition);
    }

    body.light input, body.light select {
      border: 2px solid rgba(0, 0, 0, 0.1);
      background: rgba(0, 0, 0, 0.05);
      color: var(--light-text);
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(138, 43, 226, 0.3);
    }

    /* Editor */
    #editorTab {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--dark-bg);
      color: var(--dark-text);
      padding: 20px;
      z-index: 1000;
      overflow-y: auto;
      transform: translateY(-100%);
      transition: transform 0.5s ease;
      display: flex;
      flex-direction: column;
    }

    #editorTab.active {
      transform: translateY(0);
    }

    body.light #editorTab {
      background: var(--light-bg);
      color: var(--light-text);
    }

    .editor-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--primary);
    }

    .editor-content {
      flex: 1;
    }

    .editor-section {
      background: var(--dark-card);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      margin-bottom: 20px;
    }

    body.light .editor-section {
      background: var(--light-card);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .editor-section h3 {
      margin-bottom: 20px;
      color: var(--primary);
    }

    .lesson-editor {
      margin-bottom: 15px;
      padding: 15px;
      border-radius: 10px;
      background: rgba(0, 0, 0, 0.2);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    body.light .lesson-editor {
      background: rgba(0, 0, 0, 0.05);
    }

    .lesson-editor .input-group {
      margin-bottom: 0;
    }

    .editor-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 10px;
    }

    /* Theme toggle */
    .theme-toggle {
      position: relative;
      width: 60px;
      height: 30px;
      background: var(--dark-card);
      border-radius: 15px;
      display: flex;
      align-items: center;
      padding: 0 5px;
      cursor: pointer;
      transition: var(--transition);
      border: 2px solid var(--primary);
    }

    body.light .theme-toggle {
      background: var(--light-card);
    }

    .toggle-thumb {
      position: absolute;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--primary);
      transition: var(--transition);
      left: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    body.light .toggle-thumb {
      left: calc(100% - 25px);
      background: var(--primary-dark);
    }

    /* Notifications */
    .notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 10px;
      background: var(--dark-card);
      color: var(--dark-text);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
      gap: 10px;
      transform: translateX(100%);
      opacity: 0;
      transition: transform 0.3s ease, opacity 0.3s ease;
      z-index: 1001;
    }

    .notification.show {
      transform: translateX(0);
      opacity: 1;
    }

    .notification.success {
      border-left: 4px solid var(--success);
    }

    .notification.error {
      border-left: 4px solid var(--error);
    }

    .notification.warning {
      border-left: 4px solid var(--warning);
    }

    /* Drag and drop */
    .dragging {
      opacity: 0.7;
      box-shadow: 0 0 15px var(--primary);
    }

    /* Search and filter */
    .search-box {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .search-input {
      flex: 1;
      min-width: 200px;
    }

    /* Responsive design */
    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }

      .lesson-actions, .action-cell {
        flex-direction: column;
      }

      .schedule-table {
        display: block;
        overflow-x: auto;
      }

      .weekday-buttons {
        gap: 5px;
      }
      
      .weekday-btn {
        min-width: 35px;
        max-width: 45px;
        padding: 8px 3px;
        font-size: 0.9rem;
      }

      .editor-header {
        flex-direction: column;
        gap: 15px;
      }

      .logo {
        font-size: 1.5rem;
      }

      .logo i {
        font-size: 1.7rem;
      }

      .current-lesson-card,
      .login-panel {
        padding: 15px;
      }

      .lesson-title {
        font-size: 1.5rem;
      }

      button {
        padding: 10px 15px;
        font-size: 0.9rem;
      }
    }

    @media (max-width: 480px) {
      .container {
        padding: 0 10px;
      }

      .header-content {
        flex-direction: column;
        align-items: center;
      }

      .logo-area {
        align-items: center;
      }

      .social-links {
        margin-top: 10px;
      }

      .weekday-buttons {
        flex-wrap: nowrap;
        overflow-x: auto;
        justify-content: flex-start;
        padding-bottom: 5px;
      }

      .weekday-btn {
        flex: 0 0 auto;
      }

      .search-box {
        flex-direction: column;
      }

      .search-input {
        min-width: 100%;
      }
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .fade-in {
      animation: fadeIn 0.5s ease forwards;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.1);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 4px;
    }

    body.light ::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.05);
    }

    body.light ::-webkit-scrollbar-thumb {
      background: var(--primary-dark);
    }
    
    /* Loading spinner */
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      border-top: 4px solid var(--primary);
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Footer */
    footer {
      text-align: center;
      margin-top: 30px;
      padding: 20px;
      color: var(--dark-text);
      opacity: 0.7;
    }
    
    body.light footer {
      color: var(--light-text);
    }

    /* Mobile menu */
    .mobile-menu-btn {
      display: none;
      background: none;
      border: none;
      color: white;
      font-size: 1.5rem;
      cursor: pointer;
    }

    @media (max-width: 768px) {
      .mobile-menu-btn {
        display: block;
        position: absolute;
        top: 20px;
        right: 20px;
      }

      .header-content {
        padding-top: 40px;
      }
    }

    /* Sync indicator */
    .sync-indicator {
      position: fixed;
      bottom: 20px;
      left: 20px;
      padding: 8px 12px;
      border-radius: 20px;
      background: var(--dark-card);
      color: var(--dark-text);
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 999;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    .sync-indicator.syncing {
      color: var(--secondary);
    }

    .sync-indicator.error {
      color: var(--error);
    }

    /* Improved mobile experience */
    .touch-actions {
      display: none;
    }

    @media (hover: none) {
      .touch-actions {
        display: flex;
        margin-top: 10px;
      }
      
      .schedule-table tr {
        display: flex;
        flex-direction: column;
        padding: 15px;
      }
      
      .schedule-table td {
        padding: 8px 0;
      }
      
      .action-cell {
        margin-top: 10px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
        <i class="fas fa-bars"></i>
      </button>
      <div class="header-content">
        <div class="logo-area">
          <div class="logo">
            <i class="fas fa-graduation-cap"></i>
            <span>Умное расписание</span>
          </div>
          <div class="made-by">made by Tufg144</div>
        </div>
        <div class="social-links">
          <a href="https://t.me/your_telegram_group" class="social-btn" target="_blank">
            <i class="fab fa-telegram"></i>
            <span class="social-tooltip">Группа школы в Telegram</span>
          </a>
          <a href="https://discord.gg/your_discord_server" class="social-btn" target="_blank">
            <i class="fab fa-discord"></i>
            <span class="social-tooltip">Группа школы в Discord</span>
          </a>
          <div class="theme-toggle" onclick="toggleTheme()">
            <div class="toggle-thumb">
              <i class="fas fa-sun" style="display: none;"></i>
              <i class="fas fa-moon"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <section class="current-lesson-card fade-in">
      <h2>Текущий урок</h2>
      <div id="currentLesson">
        <div class="spinner"></div>
      </div>
    </section>

    <div class="weekday-buttons fade-in" id="weekdaySelector">
      <!-- Будет заполнено JavaScript -->
    </div>

    <div class="search-box fade-in">
      <div class="input-group search-input">
        <input type="text" id="searchInput" placeholder="Поиск уроков..." oninput="filterLessons()">
      </div>
      <select id="timeFilter" onchange="filterLessons()">
        <option value="all">Все уроки</option>
        <option value="current">Текущие и будущие</option>
        <option value="past">Прошедшие</option>
      </select>
    </div>

    <div class="schedule-container fade-in">
      <table class="schedule-table" id="scheduleTable"></table>
    </div>

    <div class="login-panel fade-in" id="loginPanel">
      <h3><i class="fas fa-lock"></i> Вход для администратора</h3>
      <div class="input-group">
        <label for="login">Логин</label>
        <input type="text" id="login" placeholder="Введите логин">
      </div>
      <div class="input-group">
        <label for="password">Пароль</label>
        <input type="password" id="password" placeholder="Введите пароль">
      </div>
      <button onclick="login()" class="secondary"><i class="fas fa-sign-in-alt"></i> Войти</button>
    </div>
  </div>

  <!-- Editor Tab -->
  <div id="editorTab">
    <div class="editor-header">
      <h2><i class="fas fa-edit"></i> Редактор расписания</h2>
      <button onclick="closeEditor()"><i class="fas fa-arrow-left"></i> Назад к расписанию</button>
    </div>

    <div class="editor-content">
      <div class="editor-section">
        <h3><i class="fas fa-calendar-alt"></i> Редактирование расписания</h3>
        <div class="weekday-buttons" id="editorWeekdaySelector">
          <!-- Будет заполнено JavaScript -->
        </div>
        <div id="dayEditor"></div>
        <button onclick="addDayLesson()" class="secondary"><i class="fas fa-plus"></i> Добавить урок</button>
        <button onclick="resetDaySchedule()" class="danger"><i class="fas fa-undo"></i> Сбросить к основному</button>
      </div>
    </div>
  </div>

  <div class="sync-indicator" id="syncIndicator">
    <i class="fas fa-check-circle"></i>
    <span>Данные синхронизированы</span>
  </div>

  <footer class="fade-in">
    <p>Умное расписание уроков &copy; 2023 | Обновлено: <span id="lastUpdated"></span></p>
  </footer>

  <script>
    // Data management
    let schedule = JSON.parse(localStorage.getItem('schedule')) || {
      "Понедельник": [
        { time: "09:00", subject: "Математика", link: "https://meet.google.com/math", room: "101" },
        { time: "10:00", subject: "Английский язык", link: "https://meet.google.com/english", room: "202" }
      ],
      "Вторник": [
        { time: "09:00", subject: "Физика", link: "https://meet.google.com/physics", room: "305" },
        { time: "11:00", subject: "История", link: "https://meet.google.com/history", room: "404" }
      ],
      "Среда": [
        { time: "10:00", subject: "Химия", link: "https://meet.google.com/chemistry", room: "105" }
      ],
      "Четверг": [
        { time: "09:00", subject: "Литература", link: "https://meet.google.com/literature", room: "203" }
      ],
      "Пятница": [
        { time: "09:00", subject: "Информатика", link: "https://meet.google.com/informatics", room: "Компьютерный класс" }
      ],
      "Суббота": [],
      "Воскресенье": []
    };

    let mainSchedule = JSON.parse(localStorage.getItem('mainSchedule')) || [
      { time: "09:00", subject: "Математика", link: "https://meet.google.com/default", room: "101" },
      { time: "10:00", subject: "Русский язык", link: "https://meet.google.com/default", room: "102" },
      { time: "11:00", subject: "Физика", link: "https://meet.google.com/default", room: "103" }
    ];

    let settings = JSON.parse(localStorage.getItem('settings')) || {
      passwordHash: '03ac674216f3e15c761ee1a5e255f067953623c8b388b4459e13f978d7c846f4', // password: 1234
      notifications: true,
      lastUpdated: new Date().toLocaleDateString('ru-RU')
    };

    let days = ["Понедельник", "Вторник", "Среда", "Четверг", "Пятница", "Суббота", "Воскресенье"];
    let dayShortNames = ["пн", "вт", "ср", "чт", "пт", "сб", "вс"];
    let currentDayIndex = new Date().getDay() - 1;
    if (currentDayIndex < 0 || currentDayIndex > 6) currentDayIndex = 0;
    let currentEditorDayIndex = currentDayIndex;
    let dragSrcEl = null;
    let isAdmin = false;

    // Initialize the app
    function init() {
      document.getElementById('lastUpdated').textContent = settings.lastUpdated;
      renderWeekdayButtons();
      renderSchedule();
      renderCurrentLesson();
      
      // Check for notifications every minute
      setInterval(() => {
        renderCurrentLesson();
        checkNotifications();
      }, 60000);
      
      // Check for notifications on load
      setTimeout(checkNotifications, 2000);
      
      // Set up auto-save
      setInterval(saveData, 30000);
      
      // Check if user was previously logged in
      checkAdminStatus();
      
      // Initialize service worker for offline functionality
      initServiceWorker();
    }

    // Initialize service worker
    function initServiceWorker() {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js').then(() => {
          console.log('Service Worker registered');
        }).catch(err => {
          console.log('Service Worker registration failed: ', err);
        });
      }
    }

    // Render weekday buttons with short names
    function renderWeekdayButtons() {
      const weekdayContainer = document.getElementById('weekdaySelector');
      const editorWeekdayContainer = document.getElementById('editorWeekdaySelector');
      
      weekdayContainer.innerHTML = '';
      editorWeekdayContainer.innerHTML = '';
      
      days.forEach((day, index) => {
        const isWeekend = index >= 5;
        const isActive = index === currentDayIndex;
        const shortName = dayShortNames[index];
        
        const button = document.createElement('button');
        button.className = `weekday-btn ${isWeekend ? 'weekend' : ''} ${isActive ? 'active' : ''}`;
        button.textContent = shortName;
        button.title = day; // Полное название при наведении
        button.onclick = () => changeDay(index);
        
        weekdayContainer.appendChild(button);
        
        // Кнопки для редактора
        const editorButton = document.createElement('button');
        editorButton.className = `weekday-btn ${isWeekend ? 'weekend' : ''} ${index === currentEditorDayIndex ? 'active' : ''}`;
        editorButton.textContent = shortName;
        editorButton.title = day;
        editorButton.onclick = () => changeEditorDay(index);
        
        editorWeekdayContainer.appendChild(editorButton);
      });
    }

    // Save data to localStorage
    function saveData() {
      localStorage.setItem('schedule', JSON.stringify(schedule));
      localStorage.setItem('mainSchedule', JSON.stringify(mainSchedule));
      settings.lastUpdated = new Date().toLocaleDateString('ru-RU');
      localStorage.setItem('settings', JSON.stringify(settings));
      
      // Show sync indicator
      const indicator = document.getElementById('syncIndicator');
      indicator.innerHTML = '<i class="fas fa-sync-alt"></i> <span>Синхронизация...</span>';
      indicator.classList.add('syncing');
      
      setTimeout(() => {
        indicator.innerHTML = '<i class="fas fa-check-circle"></i> <span>Данные синхронизированы</span>';
        indicator.classList.remove('syncing');
      }, 1000);
    }

    // Render schedule table
    function renderSchedule() {
      let day = days[currentDayIndex];
      document.getElementById("dayName")?.remove(); // Удаляем старый заголовок, если есть
      
      // Создаем новый заголовок
      const dayTitle = document.createElement('h2');
      dayTitle.id = 'dayName';
      dayTitle.className = 'day-title fade-in';
      dayTitle.textContent = day;
      
      // Вставляем заголовок перед таблицей
      const scheduleContainer = document.querySelector('.schedule-container');
      scheduleContainer.parentNode.insertBefore(dayTitle, scheduleContainer);
      
      let table = document.getElementById("scheduleTable");
      
      table.innerHTML = `
        <tr>
          <th>Время</th>
          <th>Урок</th>
          <th>Кабинет</th>
          <th>Действия</th>
        </tr>
      `;
      
      let lessons = schedule[day] && schedule[day].length > 0 ? schedule[day] : mainSchedule;
      
      // Sort lessons by time
      lessons.sort((a, b) => {
        return a.time.localeCompare(b.time);
      });
      
      if (lessons.length === 0) {
        const row = table.insertRow();
        row.innerHTML = `
          <td colspan="4" style="text-align: center; padding: 20px;">
            На ${day.toLowerCase()} уроков нет
          </td>
        `;
        return;
      }
      
      lessons.forEach((lesson, index) => {
        let row = table.insertRow();
        row.draggable = isAdmin; // Allow dragging only for admin
        row.dataset.index = index;
        row.innerHTML = `
          <td class="time-cell">${lesson.time}</td>
          <td class="subject-cell">${lesson.subject}</td>
          <td>${lesson.room || '-'}</td>
          <td class="action-cell">
            <button onclick="join('${lesson.link}')" class="secondary"><i class="fas fa-video"></i> Присоединиться</button>
            <button onclick="copyLink('${lesson.link}')"><i class="fas fa-copy"></i> Скопировать</button>
            ${isAdmin ? `<button onclick="editLesson('${day}', ${index})" class="outline"><i class="fas fa-edit"></i> Изменить</button>` : ''}
          </td>
        `;
        
        // Add drag and drop event listeners only for admin
        if (isAdmin) {
          row.addEventListener('dragstart', handleDragStart);
          row.addEventListener('dragover', handleDragOver);
          row.addEventListener('dragleave', handleDragLeave);
          row.addEventListener('drop', handleDrop);
          row.addEventListener('dragend', handleDragEnd);
        }
      });
    }

    // Edit lesson function
    function editLesson(day, index) {
      let lessons = schedule[day] && schedule[day].length > 0 ? schedule[day] : mainSchedule;
      let lesson = lessons[index];
      
      let newTime = prompt("Введите новое время (HH:MM):", lesson.time);
      if (!newTime) return;
      
      let newSubject = prompt("Введите новый предмет:", lesson.subject);
      if (!newSubject) return;
      
      let newLink = prompt("Введите новую ссылку:", lesson.link);
      if (newLink === null) return;
      
      let newRoom = prompt("Введите новый кабинет:", lesson.room || "");
      
      lessons[index] = {
        time: newTime,
        subject: newSubject,
        link: newLink,
        room: newRoom
      };
      
      if (schedule[day] && schedule[day].length > 0) {
        schedule[day] = lessons;
      } else {
        mainSchedule = lessons;
      }
      
      renderSchedule();
      saveData();
      showNotification("Урок изменен", "success");
    }

    // Drag and drop handlers
    function handleDragStart(e) {
      this.style.opacity = '0.4';
      dragSrcEl = this;
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', this.dataset.index);
    }

    function handleDragOver(e) {
      if (e.preventDefault) e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      return false;
    }

    function handleDragLeave() {
      this.classList.remove('over');
    }

    function handleDrop(e) {
      if (e.stopPropagation) e.stopPropagation();
      
      if (dragSrcEl !== this) {
        let day = days[currentDayIndex];
        let lessons = schedule[day] && schedule[day].length > 0 ? schedule[day] : mainSchedule;
        
        let fromIndex = parseInt(dragSrcEl.dataset.index);
        let toIndex = parseInt(this.dataset.index);
        
        // Reorder lessons
        let movedItem = lessons[fromIndex];
        lessons.splice(fromIndex, 1);
        lessons.splice(toIndex, 0, movedItem);
        
        // Update schedule
        if (schedule[day] && schedule[day].length > 0) {
          schedule[day] = lessons;
        } else {
          mainSchedule = lessons;
        }
        
        renderSchedule();
        saveData();
      }
      
      return false;
    }

    function handleDragEnd() {
      this.style.opacity = '1';
      let items = document.querySelectorAll('.schedule-table tr');
      items.forEach(item => item.classList.remove('over'));
    }

    // Filter lessons based on search input and filter type
    function filterLessons() {
      let searchText = document.getElementById('searchInput').value.toLowerCase();
      let filterType = document.getElementById('timeFilter').value;
      let day = days[currentDayIndex];
      let lessons = schedule[day] && schedule[day].length > 0 ? schedule[day] : mainSchedule;
      let now = new Date();
      let currentTime = now.getHours() + ':' + now.getMinutes().toString().padStart(2, '0');
      
      let table = document.getElementById("scheduleTable");
      let rows = table.getElementsByTagName('tr');
      
      // Skip header row
      for (let i = 1; i < rows.length; i++) {
        let row = rows[i];
        let subject = row.cells[1].textContent.toLowerCase();
        let time = row.cells[0].textContent;
        
        let matchesSearch = subject.includes(searchText);
        let matchesFilter = true;
        
        if (filterType === 'current') {
          matchesFilter = time >= currentTime;
        } else if (filterType === 'past') {
          matchesFilter = time < currentTime;
        }
        
        row.style.display = matchesSearch && matchesFilter ? '' : 'none';
      }
    }

    // Render current lesson
    function renderCurrentLesson() {
      let now = new Date();
      let h = now.getHours().toString().padStart(2, "0");
      let m = now.getMinutes().toString().padStart(2, "0");
      let timeStr = `${h}:${m}`;
      let day = days[currentDayIndex];
      let lessons = schedule[day] && schedule[day].length > 0 ? schedule[day] : mainSchedule;
      
      // Sort lessons by time
      lessons.sort((a, b) => a.time.localeCompare(b.time));
      
      let currentLesson = null;
      let nextLesson = null;
      
      for (let i = 0; i < lessons.length; i++) {
        if (lessons[i].time >= timeStr) {
          nextLesson = lessons[i];
          break;
        } else {
          currentLesson = lessons[i];
        }
      }
      
      let container = document.getElementById("currentLesson");
      
      if (currentLesson && timeStr < addMinutes(currentLesson.time, 45)) {
        let endTime = addMinutes(currentLesson.time, 45);
        let timeLeft = timeDifference(timeStr, endTime);
        
        container.innerHTML = `
          <span class="lesson-status status-now">СЕЙЧАС</span>
          <h3 class="lesson-title">${currentLesson.subject}</h3>
          <p class="lesson-time">${currentLesson.time} - ${endTime} | Кабинет: ${currentLesson.room || '-'}</p>
          <p class="timer">До конца урока: ${timeLeft}</p>
          <div class="lesson-actions">
            <button onclick="join('${currentLesson.link}')" class="secondary"><i class="fas fa-video"></i> Присоединиться</button>
            <button onclick="copyLink('${currentLesson.link}')"><i class="fas fa-copy"></i> Скопировать ссылку</button>
            ${isAdmin ? `<button onclick="editLesson('${day}', ${lessons.indexOf(currentLesson)})" class="outline"><i class="fas fa-edit"></i> Изменить</button>` : ''}
          </div>
        `;
      } else if (nextLesson) {
        let timeLeft = timeDifference(timeStr, nextLesson.time);
        
        container.innerHTML = `
          <span class="lesson-status status-next">СКОРО</span>
          <h3 class="lesson-title">${nextLesson.subject}</h3>
          <p class="lesson-time">Начало в ${nextLesson.time} | Кабинет: ${nextLesson.room || '-'}</p>
          <p class="timer">До начала: ${timeLeft}</p>
          <div class="lesson-actions">
            <button onclick="join('${nextLesson.link}')" class="secondary"><i class="fas fa-video"></i> Присоединиться</button>
            <button onclick="copyLink('${nextLesson.link}')"><i class="fas fa-copy"></i> Скопировать ссылку</button>
            <button onclick="setReminder('${nextLesson.subject}', '${nextLesson.time}')" class="outline"><i class="fas fa-bell"></i> Напомнить</button>
            ${isAdmin ? `<button onclick="editLesson('${day}', ${lessons.indexOf(nextLesson)})" class="outline"><i class="fas fa-edit"></i> Изменить</button>` : ''}
          </div>
        `;
      } else {
        container.innerHTML = `
          <span class="lesson-status status-none">ЗАНЯТИЙ НЕТ</span>
          <p>На сегодня уроков больше не запланировано.</p>
        `;
      }
    }

    // Helper function to add minutes to time string
    function addMinutes(time, minutes) {
      let [h, m] = time.split(':').map(Number);
      let date = new Date();
      date.setHours(h, m + minutes, 0);
      return date.getHours().toString().padStart(2, '0') + ':' + date.getMinutes().toString().padStart(2, '0');
    }

    // Helper function to calculate time difference
    function timeDifference(now, then) {
      let [nowH, nowM] = now.split(':').map(Number);
      let [thenH, thenM] = then.split(':').map(Number);
      
      let nowTotal = nowH * 60 + nowM;
      let thenTotal = thenH * 60 + thenM;
      
      if (thenTotal < nowTotal) {
        thenTotal += 24 * 60; // Add a day if time is tomorrow
      }
      
      let diff = thenTotal - nowTotal;
      let h = Math.floor(diff / 60);
      let m = diff % 60;
      
      if (h > 0) {
        return `${h} ч ${m} мин`;
      } else {
        return `${m} мин`;
      }
    }

    // Check for upcoming lessons and show notifications
    function checkNotifications() {
      if (!settings.notifications) return;
      
      let now = new Date();
      let h = now.getHours().toString().padStart(2, "0");
      let m = now.getMinutes().toString().padStart(2, "0");
      let timeStr = `${h}:${m}`;
      let day = days[currentDayIndex];
      let lessons = schedule[day] && schedule[day].length > 0 ? schedule[day] : mainSchedule;
      
      lessons.forEach(lesson => {
        // Check if lesson starts in 5 minutes
        let lessonTime = lesson.time;
        if (timeDifference(timeStr, lessonTime) === '5 мин') {
          showNotification(`Через 5 минут начинается ${lesson.subject}`, 'warning');
        }
      });
    }

    // Set reminder for a lesson
    function setReminder(subject, time) {
      if ('Notification' in window) {
        Notification.requestPermission().then(permission => {
          if (permission === 'granted') {
            let now = new Date();
            let [h, m] = time.split(':').map(Number);
            let reminderTime = new Date();
            reminderTime.setHours(h, m - 5, 0);
            
            if (reminderTime < now) {
              reminderTime.setDate(reminderTime.getDate() + 1);
            }
            
            let timeout = reminderTime.getTime() - now.getTime();
            
            setTimeout(() => {
              new Notification('Напоминание о уроке', {
                body: `Через 5 минут начинается ${subject}`,
                icon: 'https://example.com/icon.png'
              });
            }, timeout);
            
            showNotification('Напоминание установлено', 'success');
          }
        });
      } else {
        showNotification('Ваш браузер не поддерживает уведомления', 'error');
      }
    }

    // Show notification
    function showNotification(message, type) {
      if (!settings.notifications) return;
      
      let notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'bell'}"></i>
        <span>${message}</span>
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.classList.add('show');
      }, 100);
      
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 300);
      }, 3000);
    }

    // Join lesson
    function join(link) { 
      window.open(link, "_blank"); 
    }

    // Copy link to clipboard
    function copyLink(link) { 
      navigator.clipboard.writeText(link); 
      showNotification("Ссылка скопирована в буфер обмена", "success");
    }

    // Navigation functions
    function changeDay(index) { 
      currentDayIndex = index;
      renderWeekdayButtons();
      renderSchedule(); 
      renderCurrentLesson();
    }

    // Authentication
    async function login() {
      let user = document.getElementById("login").value;
      let pass = document.getElementById("password").value;
      
      // Hash the password using SHA-256
      const encoder = new TextEncoder();
      const data = encoder.encode(pass);
      const hash = await crypto.subtle.digest('SHA-256', data);
      const hashArray = Array.from(new Uint8Array(hash));
      const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
      
      if (user === "admin" && hashHex === settings.passwordHash) {
        isAdmin = true;
        localStorage.setItem('isAdmin', 'true');
        openEditor();
        document.getElementById("login").value = "";
        document.getElementById("password").value = "";
        showNotification("Вы вошли как администратор", "success");
      } else {
        showNotification("Неверные учетные данные", "error");
      }
    }

    // Check if user is admin
    function checkAdminStatus() {
      if (localStorage.getItem('isAdmin') === 'true') {
        isAdmin = true;
        showNotification("Вы вошли как администратор", "success");
      }
    }

    // Logout function
    function logout() {
      isAdmin = false;
      localStorage.removeItem('isAdmin');
      closeEditor();
      showNotification("Вы вышли из системы", "success");
    }

    // Change password
    async function changePassword() {
      let oldPass = prompt("Введите текущий пароль:");
      if (!oldPass) return;
      
      // Hash the old password
      const encoder = new TextEncoder();
      const oldData = encoder.encode(oldPass);
      const oldHash = await crypto.subtle.digest('SHA-256', oldData);
      const oldHashArray = Array.from(new Uint8Array(oldHash));
      const oldHashHex = oldHashArray.map(b => b.toString(16).padStart(2, '0')).join('');
      
      if (oldHashHex !== settings.passwordHash) {
        showNotification("Неверный текущий пароль", "error");
        return;
      }
      
      let newPass = prompt("Введите новый пароль:");
      if (!newPass) return;
      
      // Hash the new password
      const newData = encoder.encode(newPass);
      const newHash = await crypto.subtle.digest('SHA-256', newData);
      const newHashArray = Array.from(new Uint8Array(newHash));
      const newHashHex = newHashArray.map(b => b.toString(16).padStart(2, '0')).join('');
      
      settings.passwordHash = newHashHex;
      saveData();
      showNotification("Пароль успешно изменен", "success");
    }

    // Theme toggle
    function toggleTheme() {
      document.body.classList.toggle("light");
      let icon = document.querySelector('.toggle-thumb i');
      
      if (document.body.classList.contains("light")) {
        icon.classList.remove('fa-moon');
        icon.classList.add('fa-sun');
        localStorage.setItem('theme', 'light');
      } else {
        icon.classList.remove('fa-sun');
        icon.classList.add('fa-moon');
        localStorage.setItem('theme', 'dark');
      }
    }

    // Check saved theme
    function checkSavedTheme() {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'light') {
        document.body.classList.add('light');
        let icon = document.querySelector('.toggle-thumb i');
        icon.classList.remove('fa-moon');
        icon.classList.add('fa-sun');
      }
    }

    // Mobile menu toggle
    function toggleMobileMenu() {
      const headerContent = document.querySelector('.header-content');
      headerContent.classList.toggle('mobile-open');
    }

    // Editor functions
    function openEditor() {
      document.getElementById("editorTab").classList.add("active");
      renderDayEditor();
    }

    function closeEditor() { 
      document.getElementById("editorTab").classList.remove("active"); 
      saveData();
    }
    
    function changeEditorDay(index) {
      currentEditorDayIndex = index;
      renderWeekdayButtons();
      renderDayEditor();
    }
    
    function resetDaySchedule() {
      const day = days[currentEditorDayIndex];
      if (confirm(`Вы уверены, что хотите сбросить расписание на ${day}?`)) {
        schedule[day] = [];
        renderDayEditor();
        showNotification(`Расписание на ${day} сброшено`, 'success');
      }
    }

    function renderDayEditor() {
      let day = days[currentEditorDayIndex];
      let dayDiv = document.getElementById("dayEditor");
      dayDiv.innerHTML = "";
      
      if (!schedule[day]) schedule[day] = [];
      
      let lessons = schedule[day].length > 0 ? schedule[day] : mainSchedule;
      let isCustom = schedule[day].length > 0;
      
      dayDiv.innerHTML = `<p style="margin-bottom: 15px;">Редактирование расписания на <strong>${day}</strong>. ${isCustom ? 'Используется индивидуальное расписание.' : 'Используется основное расписание.'}</p>`;
      
      lessons.forEach((lesson, i) => {
        let lessonDiv = document.createElement('div');
        lessonDiv.className = 'lesson-editor';
        lessonDiv.innerHTML = `
          <div class="input-group">
            <label>Время</label>
            <input type="time" value="${lesson.time}" onchange="${isCustom ? `schedule['${day}'][${i}].time=this.value` : `mainSchedule[${i}].time=this.value`}">
          </div>
          <div class="input-group">
            <label>Предмет</label>
            <input value="${lesson.subject}" onchange="${isCustom ? `schedule['${day}'][${i}].subject=this.value` : `mainSchedule[${i}].subject=this.value`}">
          </div>
          <div class="input-group">
            <label>Ссылка</label>
            <input value="${lesson.link}" onchange="${isCustom ? `schedule['${day}'][${i}].link=this.value` : `mainSchedule[${i}].link=this.value`}">
          </div>
          <div class="input-group">
            <label>Кабинет</label>
            <input value="${lesson.room || ''}" placeholder="Не указан" onchange="${isCustom ? `schedule['${day}'][${i}].room=this.value` : `mainSchedule[${i}].room=this.value`}">
          </div>
          <div class="editor-actions">
            <button onclick="${isCustom ? `removeDayLesson('${day}', ${i})` : `removeMainLesson(${i})`}" class="danger"><i class="fas fa-trash"></i> Удалить</button>
          </div>
        `;
        dayDiv.appendChild(lessonDiv);
      });
    }

    function addDayLesson() {
      let day = days[currentEditorDayIndex];
      if (!schedule[day]) schedule[day] = [];
      
      // Если используется основное расписание, скопируем его сначала
      if (schedule[day].length === 0) {
        schedule[day] = JSON.parse(JSON.stringify(mainSchedule));
      }
      
      schedule[day].push({time: "09:00", subject: "Новый урок", link: "", room: ""});
      renderDayEditor();
    }

    function removeMainLesson(index) {
      if (confirm("Удалить этот урок из основного расписания?")) {
        mainSchedule.splice(index, 1);
        renderDayEditor();
      }
    }

    function removeDayLesson(day, index) {
      if (confirm("Удалить этот урок?")) {
        schedule[day].splice(index, 1);
        renderDayEditor();
      }
    }

    // Initialize the app
    window.onload = function() {
      init();
      checkSavedTheme();
    };
  </script>
</body>
</html>